<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>dataScraping</title>
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.js"
		integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
	<script src="./js/bootstrap.js"></script>
	<script src="./js/jqurey.number.js"></script>
	<!-- echarts -->
	<script src="./js/echarts.min.js"></script>

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.css">
	<link rel="stylesheet" href="./css/daterangepicker.css">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
	</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
	</script>
	<script src="https://kit.fontawesome.com/a04ef755a4.js" crossorigin="anonymous"></script>
	<!-- BS Table -->
	<script src="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.js"></script>
	<script src="https://unpkg.com/bootstrap-table@1.15.5/dist/extensions/export/bootstrap-table-export.min.js">
	</script>
	<!-- JS Exports plugin -->
	<script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
	<script src="https://unpkg.com/tableexport.jquery.plugin/libs/jsPDF/jspdf.min.js"></script>
	<script src="https://unpkg.com/tableexport.jquery.plugin/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
	<script src="./js/moment.min.js"></script>
	<script src="./js/daterangepicker.js"></script>

</head>

<body style="background-color: #e2e2e2;">
	<nav class="navbar sticky-top navbar-expand-lg navbar-dark  bg-gradient" style="background-color: #262626;">
		<div class="container" style="margin-left: 281px;">
			<ul class="navbar-nav">
				<li class="nav-item">
					<a href="index.html" class="nav-link">即時監控</a>
				</li>
				<li class="nav-item">
					<a href="dataScraping.html" class="nav-link">資料分析</a>
				</li>
			</ul>
		</div>
	</nav>
	<div class="container-fluid mt-3 mr-0">
		<div class="row ">
			<div class="col-md-6">
				<!-- 左一---------------------------------------------------------------------------------------------- -->
				<div class="card shadow" style="height:874px;width:942px">
					<div class="card-header title py-1" style="font-size: 14px;font-weight: 900;">
						<div class="row g-1 align-items-center">
							<div class="col-auto">
								<div class="col-form-label subtitle p-0">資料報表</div>
							</div>
						</div>
					</div>
					<div class="card-body" style="font-size: 12px;">
						<div class="table-responsive">
							<div class="toolbar">
								<div class="row">
									<div class="col-12">
										<div class="row">
											<div class="col-6">
												<div class="form-floating">
													<input type="number" class="form-control f_tr"
														id="floatingInputGrid" placeholder="第一段警報溫度" value="">
													<label for="floatingInputGrid">第一段警報溫度</label>
												</div>
											</div>
											<div class="col-6">
												<div class="form-floating">
													<input type="number" class="form-control s_tr"
														id="floatingInputGrid" placeholder="第一段警報溫度" value="">
													<label for="floatingInputGrid">第二段警報溫度</label>
												</div>
											</div>
										</div>
									</div>
									<div class="col-12 pt-1">
										<div class="form-floating">
											<input name="dates" class="form-control" id="floatingInputGrid" />
											<label for="floatingInputGrid">選擇資料日期範圍</label>
										</div>
									</div>
								</div>
							</div>
							<table id="table2" data-height="807" data-toolbar=".toolbar" data-show-export="true"
								data-pagination="false" data-click-to-select="true" data-toolbar="#toolbar"
								data-show-toggle="true" data-show-columns="true" data-sortable="true"
								data-toggle="table2" data-search="true" data-live-search="true" data-show-refresh="true"
								data-unique-id="id">
								<thead>
									<form class="data-report">
										<button hidden="true" type="submit"></button>
									</form>
								</thead>
							</table>

						</div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="row">
					<div class="col-md-12">
						<!-- 下1---------------------------------------------------------------------------------------------- -->
						<div class="card shadow" style="height:296px;">
							<div class="card-header title py-1" style="font-size: 14px;font-weight: 900;">
								<div class="row g-3 align-items-center">
									<div class="col-auto">
										<div class="col-form-label subtitle p-0">錄影回放</div>
									</div>
								</div>
							</div>
							<div class="card-body p-0 position-relative">
								<div class="video-loading">
									<div>影像載入中...</div>
								</div>
								<div class="video-loading-bg"></div>
								<div class="row align-items-center tri subtitle mx-4 mb-1 pt-1">
									<div class="col-4">
										&nbsp;&nbsp;&nbsp;L/F 副料區
									</div>
									<div class="col-4">
										&nbsp;&nbsp;&nbsp;出鋼室地下樓梯
									</div>
									<div class="col-4">
										&nbsp;&nbsp;&nbsp;L/D 2F平台
									</div>
								</div>
								<video id="videoList" loop controls muted preload src="" class="video2 imgCenter">
								</video>
							</div>
						</div>
					</div>
					<div class="col-md-12 ">
						<!-- 下1---------------------------------------------------------------------------------------------- -->
						<div class="card mt-3 shadow " style="height:273px;">
							<div class="card-header title py-1" style="font-size: 14px;font-weight: 900;">
								<div class="row g-3 align-items-center">
									<div class="col-auto">
										<div class="col-form-label subtitle p-0">趨勢圖</div>
									</div>

								</div>
							</div>
							<div class="card-body p-0 ">
								<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
								<div id="main" style="width: 920px;height:290px;"></div>

							</div>
						</div>
					</div>
					<div class="col-md-12">
						<!-- 下1---------------------------------------------------------------------------------------------- -->
						<div class="card mt-3 shadow" style="height:273px;">
							<div class="card-header title py-1" style="font-size: 14px;font-weight: 900;">
								<div class="row g-3 align-items-center">
									<div class="col-auto">
										<div class="col-form-label subtitle p-0">吊起桶數</div>
									</div>
								</div>
							</div>
							<div class="card-body p-0 ">

								<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
								<div id="main2" style="width: 920px;height:228px;padding-bottom: 0px;">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="./js/dataScraping.js"></script>
	<script>
		const url = 'http://127.0.0.1:5000/api/analysis/refresh'
		var myChart = echarts.init(document.getElementById('main2'));
		// prettier-ignore
		// (x, y , 0:沒事 1:有事, 拉了幾桶(3桶/hr))
		var Interval = null
		option = {
			aria: {
				enabled: true
			},
			title: {
				textStyle: {
					color: '#6f6f6f',
					fontSize: 12,
					lineHeight: 50,
				},
				x: 'right'
			},
			tooltip: {
				position: 'top'
			},
			animation: false,
			grid: {
				height: '72%',
				top: '20%',
				width: '80%',
				// width: '91%',
				left: '48',
			},
			xAxis: {
				type: 'category',
				name: '(hr)',
				data: ['0', '1', '2', '3', '4', '5', '6',
					'7', '8', '9', '10', '11',
					'12', '13', '14', '15', '16', '17',
					'18', '19', '20', '21', '22', '23'
				],
				splitArea: {
					show: true
				}
			},

			yAxis: {
				type: 'category',
				data: [0, 10, 20, 30, 40, 50],
				name: '(m)',
				splitArea: {
					show: true,
				},
			},
			visualMap: {
				show: true,
				min: 0,
				// max: 5,
				calculable: true,
				// orient: 'horizontal',
				orient: 'vertical',
				top: '45',
				right: '30',
				bottom: '15%',
				color: ['#7E6E68', '#907D76', '#A99792', '#BBACA9', '#D0C8C7']
			},
			series: [{
				name: '',
				type: 'heatmap',
				label: {
					show: true,
					normal: {
						show: true,
						formatter: function (params) {
							if (params.data['2'] == 0) {
								return '{a|' + params.data['3'] + '}';
							} else if (params.data['2'] == 1) {
								return '{b|' + params.data['3'] + '}';
							} else if (params.data['2'] == 2) {
								return '{c|' + params.data['3'] + '}';
							}
						},
						rich: {
							a: {
								//  backgroundColor:'#fff',
								color: '#E3DCD3'
							},
							b: {
								backgroundColor: '#811C21',
								height: '26',
								width: '3',
								shadowOffsetY: '0',
								shadowOffsetX: '0',
								align: 'center',
							},
							c: {
								backgroundColor: '#B56666',
								height: '26',
								width: '3',
								shadowOffsetY: '0',
								shadowOffsetX: '0',
								align: 'center',
							},
						}
					}
				},
				emphasis: {
					itemStyle: {
						shadowBlur: 10,
						shadowColor: 'rgba(0, 0, 0, 0.5)'
					}
				}
			}]
		};
		// 使用刚指定的配置项和数据显示图表。
		myChart.setOption(option);
		//初始化資料報表

		$('.table-responsive').on('click', 'button', function () {
			if (this.name === "refresh") {
				// getData(url)
			}
		})
		$(window).keypress(function (event) {
			if (event.which === 13) {
				getData(url)
			}
		})
		getData(url)
		// 判斷表單點到的日期
		var clickSum = null;
		$('.table-responsive').on('click', 'tr', function () {
			var id = parseInt($(this).attr("data-index")) + 1
			if (!isNaN(id)) { // 判斷id是否有數字

				if (clickSum !== id) { // 判斷是否點擊同一列
					if (Interval !== null) {
						clearInterval(Interval)
					}
					const data = $('#table2').bootstrapTable(
						'getRowByUniqueId',
						id)
					var clickdata = new Date(data.table_start)
					getData(url, clickdata)
				}
			}
			clickSum = id
		})

		function getData(url, clickdata) {
			// var date_range = $('#date_range').val();
			// console.log(date_range)
			// console.log($('input[name="dates"]').data('daterangepicker').endDate)
			if (clickdata != undefined) {
				// console.log(clickdata)
				var date = new Date(clickdata)
			} else {
				var date = new Date()
			}
			var time = date.getFullYear() +
				"-" +
				(date.getMonth() + 1).toString().padStart(2, '0') +
				"-" +
				date.getDate().toString().padStart(2, '0')
			var range = {
				"table_timeselectStart": time + " 00:00:00",
				"table_timeselectStop": time + " 23:59:59"
			}
			console.log(range)

			range = JSON.stringify(range)
			$.ajax({
				url: url,
				method: 'POST',
				data: range,
				dataType: "json",
				contentType: 'application/json; charset=utf-8',
				success: function (data) {
					var data = listinterval(data, clickdata)
					// 判斷時段中拉起桶數的最大值
					var max = []
					data.forEach(function (item) {
						max.push(item[3])
					})
					max = Math.max(...max)
					// 判斷時段中拉起桶數的最大值 end
					data = data.map(function (item) {
						return [item[0], item[1], item[2], item[3]];
					})
					myChart.setOption({
						visualMap: {
							max: max
						},
						title: {
							text: '統計日期:' + time,
						},
						series: [{
							name: '',
							data: data,
						}]
					});
				},
				error: function (err) {
					console.log(err)
				},
			})
		}
		// -------時間計算器
		// setInterval(function () {
		// 	jQuery.ajax({
		// 		url: '/list',
		// 		method: 'GET',
		// 		dataType: "json",
		// 		success: function (res) {
		// 			var data = listinterval(res)
		// 			data = data.map(function (item) {
		// 				return [item[0], item[1], item[2], item[3]];
		// 			})
		// 			myChart.setOption({
		// 				series: [{
		// 					name: '',
		// 					data: data,
		// 				}]
		// 			});
		// 		},
		// 		error: function (err) {
		// 			console.log(err)
		// 		},
		// 	})
		// }, 500)
		// 時間篩選
		function listinterval(res, clickdata) {
			// 撈取警報溫度
			var f_tr = null;
			var s_tr = null;
			$.ajax({
				url: 'http://localhost:5000/api/data/normal',
				dataType: "json",
				method: 'GET',
				async: false, // 關閉非同步作業
				success: function (res) {
					f_tr = res.setting_first_alarm_temperature
					s_tr = res.setting_second_alarm_temperature
				},
				error: function (err) {}
			})

			// 宣告陣列
			var output = []
			// 取得今天日期
			if (clickdata != undefined) {
				// console.log(clickdata)
				var NowDate = new Date(clickdata)
			} else {
				var NowDate = new Date()
			}
			var NYear = NowDate.getFullYear()
			var NMonth = NowDate.getMonth()
			var NDate = NowDate.getDate()

			// 設定間隔時間(設定範圍1~60，並且可除盡60)
			var interval = 10
			// 判斷interval 是否為合理範圍，否則將強制變動
			if (interval === 0) {
				interval = 1
			} else if (interval > 60) {
				interval = 60
			}
			// 計算間隔時間
			setinterval = (1440 / interval) + 1
			// 指標時間變數
			var lastTime = null
			var NewMin = null

			// 間隔十分鐘
			for (var i = 1; i < setinterval; i++) {
				// 宣告日期
				var today = new Date(NYear, NMonth, NDate)
				var today1 = new Date(NYear, NMonth, NDate)
				// 判斷初始，存入起始時間
				if (i == 1) {
					lastTime = new Date(today)
				} else {
					lastTime = new Date(lastTime)
					lastTime = today1.setMinutes(today1.getMinutes() + ((i - 1) * interval))
					lastTime = new Date(lastTime)
				}
				// 結束時間
				NewTime = today.setMinutes(today.getMinutes() + (i * interval))
				NewTime = new Date(NewTime)
				// 判斷時間
				var timeSum = 0;
				var Hours = lastTime.getHours();
				var Minutes = lastTime.getMinutes();
				var status = 0
				res.forEach(function (item) {
					var listTime = new Date(item.table_start)
					// 判斷間隔時間如果符合，就在此區段增加統計數
					if (listTime > lastTime && listTime < NewTime) {
						// 此區段如果有任何一桶有問題，則將狀態變更為1
						if (item.table_maxTempLF > f_tr && item.table_maxTempLF < s_tr || item.table_maxTempSTAIR >
							f_tr &&
							item.table_maxTempSTAIR < s_tr || item.table_maxTempLD >
							f_tr && item.table_maxTempLD < s_tr) {
							status = 1
						} else if (item.table_maxTempLF >= s_tr || item.table_maxTempSTAIR >= s_tr || item
							.table_maxTempLD >=
							s_tr) {
							status = 2
						}
						timeSum++
					}
				})
				// 將區段統計結果新增到陣列中
				array = [Hours, (Minutes / 10), status, timeSum]
				output.push(array)
			}
			// 印出陣列
			return output
		}
	</script>
</body>

</html>